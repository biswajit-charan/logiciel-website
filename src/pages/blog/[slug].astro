---
import { createClient } from "@sanity/client";
import type { PostItem } from "../../libs/PostItem";
import { formatDate } from "../../libs/formatDate";
import Layout from "../../layouts/Layout.astro";
import { PortableText } from "astro-portabletext";
import "../../styles/global.css";

export const prerender = true;

const client = createClient({
  projectId: "wfqtcpjl",
  dataset: "production",
  useCdn: false,
});

export async function getStaticPaths() {
  const client = createClient({
    projectId: "wfqtcpjl",
    dataset: "production",
    useCdn: false,
  });

  const slugs = await client.fetch(
    `*[_type == "post"]{"params": {"slug": slug.current}}`,
  );

  return slugs;
}

const { slug } = Astro.params;

if (slug === undefined) {
  throw new Error("Slug is required");
}

// Fetch the each blog post from sanity by that slug
const query = `*[_type == "post" && slug.current == $slug][0]{
  name,
  "slug": slug.current,
  "image": image.asset->url,
  date,
  tags,
  author,
  content[]{
    ...,
    _type == "image" => {
      ...,
      "url": asset->url
    }
  }
}`;

const post: PostItem | null = await client.fetch(query, { slug });

console.log(post);

if (!post) {
  throw new Error(`Post not found for slug: ${slug}`);
}

const imageUrl: string =
  typeof post.image === "string"
    ? post.image
    : ((post.image as any)?.src ?? (post.image as any)?.url ?? "");

const content = post.content ?? [];

// Filter for image and table blocks (safe even if content is empty)
const imageBlocks = content.filter((item: any) => item._type === "image");
const tableBlocks = content.filter((item: any) => item._type === "table");

// useful server-side debug logs
console.log("imageBlocks:", imageBlocks);
console.log("tableBlocks:", tableBlocks);
---

<Layout title={post.name}>
  <div class="hero relative flex items-center justify-center">
    <div class="overlay">
      <div class="container">
        <div class="mr-auto max-w-[700px] pt-16">
          <a
            class="mt-2 inline-block border-b-2 font-500 capitalize leading-3 text-white transition-colors duration-300 hover:text-primary-400"
            href="/"
          >
            <i class="fa-solid fa-arrow-left"></i>
            <span>go back</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <div class="container">
    <div class="mx-auto mb-20 mt-20 max-w-[800px]">
      <img
        src={imageUrl}
        width="500"
        height="500"
        class="mb-12 h-fit w-full rounded-lg"
        alt={post.name}
      />

      <div class="mb-12">
        <h1 class="mb-3 text-5xl font-700 leading-[1.2] md:text-800">
          {post.name}
        </h1>

        <div class="mb-4 flex items-center justify-center gap-5">
          <p class="text-200 text-primary-400">Written by {post.author}</p>
          <span class="text-neutral-600">{formatDate(post.date)}</span>
        </div>

        <ul class="mb-4 flex items-center justify-center gap-4">
          {
            post.tags?.map((tag, index) => (
              <li
                key={index}
                class="rounded-full px-3 py-2 text-[.9rem] bg-gray-200"
              >
                {tag}
              </li>
            ))
          }
        </ul>
      </div>

      <article class="prose prose-neutral lg:prose-xl dark:prose-invert">
        {
          content.map((item: any, idx: number) =>
            item._type === "image" ? (
              <img
                src={item.url || item.asset?.url || ""}
                alt={item.alt || ""}
                loading="lazy"
                class="my-6 rounded-xl shadow-md"
              />
            ) : item._type === "table" ? (
              item?.rows && item.rows.length > 0 ? (
                <table class="my-6 w-full border border-gray-300">
                  <tbody>
                    {item.rows.map((row: any, rIdx: number) => {
                      const cells = Array.isArray(row)
                        ? row
                        : (row?.cells ?? []);
                      return (
                        <tr key={rIdx}>
                          {cells.map((cell: any, cIdx: number) => (
                            <td
                              key={cIdx}
                              class="border border-gray-300 px-4 py-2"
                            >
                              {Array.isArray(cell) ? (
                                <PortableText value={cell} />
                              ) : (
                                (cell?.text ??
                                (Array.isArray(cell?.children)
                                  ? cell.children
                                      .map((c: any) => c?.text)
                                      .join("")
                                  : String(cell ?? "")))
                              )}
                            </td>
                          ))}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              ) : (
                <pre class="my-4 overflow-x-auto rounded bg-gray-100 p-3 text-xs">
                  {JSON.stringify(item, null, 2)}
                </pre>
              )
            ) : (
              <PortableText value={[item]} />
            ),
          )
        }
      </article>
    </div>
  </div>
</Layout>

<style>
  .hero {
    background-image: url(../../assets/background.svg);
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    width: 100%;
    min-height: 60vh;
  }

  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0, 0, 0, 0.8);
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
